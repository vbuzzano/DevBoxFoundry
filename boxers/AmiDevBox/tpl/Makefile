# Makefile for AmigaOS 68k using VBCC
# Generated by Boxing

# --- Load Environment ---
-include .env

# --- Shell Configuration ---
SHELL = cmd.exe

# --- Directories ---
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
ASM_DIR = $(BUILD_DIR)/asm
OBJ_DIR = $(BUILD_DIR)/obj
DIST_DIR = dist
TOOLS_DIR = $(VENDOR_DIR)/tools

# Source files (auto-detected)
SRC = $(wildcard $(SRC_DIR)/*.c)
ASM = $(wildcard $(SRC_DIR)/*.s)

# Program executable
EXE = $(DIST_DIR)/$(PROGRAM_NAME)
EXECMDPATH = $(subst /,\,$(EXE))

# Generated files
OBJS = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(SRC))
ASM_FILES = $(patsubst $(SRC_DIR)/%.c,$(ASM_DIR)/%.s,$(SRC))
ASM_OBJS = $(patsubst $(SRC_DIR)/%.s,$(OBJ_DIR)/%.o,$(ASM))
ALL_OBJS = $(OBJS) $(ASM_OBJS)

# Compiler and Linker
CC = vc
LINK = vc

# VBCC Target
TARGET = aos68k
C_INCL_VBCC = $(VBCC)/targets/m68k-amigaos/include
C_INCL_NDK39 = $(NDK39)/Include/include_h

# Includes
C_INCL_ALL = -I$(C_INCL_VBCC) -I$(C_INCL_NDK39) -I$(SRC_DIR) -I$(INCLUDE_DIR)

# CPU Target
CPU = m68080
CPU_FLAG = $(subst m,,$(CPU))

# Flags
AMIGA_FLAGS = +$(TARGET) -nostdlib
EXTRA_CFLAGS ?=
CFLAGS = -O3 -speed -sc -schedule $(C_INCL_ALL) $(EXTRA_CFLAGS) -cpu=$(CPU_FLAG)
LDFLAGS =

# --- Build Rules ---
all: build

dirs:
	@if not exist "$(BUILD_DIR)" mkdir "$(BUILD_DIR)"
	@if not exist "$(OBJ_DIR)" mkdir "$(OBJ_DIR)"
	@if not exist "$(ASM_DIR)" mkdir "$(ASM_DIR)"
	@if not exist "$(DIST_DIR)" mkdir "$(DIST_DIR)"

build: dirs $(EXE) $(ASM_FILES)
rebuild: clean build

$(EXE): $(ASM_FILES) $(ALL_OBJS)
	$(CC) $(CFLAGS) $(AMIGA_FLAGS) $(LDFLAGS) -o $@ $(ALL_OBJS)

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	$(CC) $(CFLAGS) $(AMIGA_FLAGS) -c -o $@ $<

$(ASM_DIR)/%.s: $(SRC_DIR)/%.c
	$(CC) $(CFLAGS) $(AMIGA_FLAGS) -S -o $@ $<

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.s
	$(CC) $(CFLAGS) $(AMIGA_FLAGS) -c -o $@ $<

clean:
	@if exist "$(BUILD_DIR)" rmdir /s /q "$(BUILD_DIR)"
	@if exist "$(DIST_DIR)" rmdir /s /q "$(DIST_DIR)"

.PHONY: all build rebuild clean dirs
