# ============================================================================
# Environment Files Generation
# ============================================================================

function Generate-DotEnvFile {
    $envPath = Join-Path $BaseDir ".env"
    $state = Load-State

    $lines = @(
        "# Generated by box - DO NOT EDIT"
        "# Re-run 'box env update' to regenerate"
        "# $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        ""
        "# Project Settings"
    )

    # Project settings from merged config
    # Support both flat keys (PROJECT_NAME) and nested (Project.Name)
    if ($Config.PROJECT_NAME) {
        $lines += "PROJECT_NAME=$($Config.PROJECT_NAME)"
        $programName = if ($Config.PROGRAM_NAME) { $Config.PROGRAM_NAME } else { $Config.PROJECT_NAME }
        $lines += "PROGRAM_NAME=$programName"
    } elseif ($Config.Project -and $Config.Project.Name) {
        $lines += "PROJECT_NAME=$($Config.Project.Name)"
        $lines += "PROGRAM_NAME=$($Config.Project.Name)"
    }

    if ($Config.DESCRIPTION) {
        $lines += "DESCRIPTION=$($Config.DESCRIPTION)"
    } elseif ($Config.Project -and $Config.Project.Description) {
        $lines += "DESCRIPTION=$($Config.Project.Description)"
    }

    if ($Config.VERSION) {
        $lines += "VERSION=$($Config.VERSION)"
    } elseif ($Config.Project -and $Config.Project.Version) {
        $lines += "VERSION=$($Config.Project.Version)"
    }

    # CPU/FPU from nested config only
    if ($Config.Project) {
        if ($Config.Project.DefaultCPU) {
            $lines += "DEFAULT_CPU=$($Config.Project.DefaultCPU)"
        }
        if ($Config.Project.DefaultFPU) {
            $lines += "DEFAULT_FPU=$($Config.Project.DefaultFPU)"
        }
    }

    $lines += ""
    $lines += "# Project Paths"

    # Paths from merged config
    if ($Config.Paths) {
        foreach ($key in $Config.Paths.Keys) {
            $value = $Config.Paths[$key]
            $envKey = ($key -creplace '([A-Z])', '_$1').ToUpper().TrimStart('_')
            $lines += "$envKey=$value"
        }
    }

    $lines += ""
    $lines += "# Package Paths"

    foreach ($pkgName in $state.packages.Keys) {
        $pkg = $state.packages[$pkgName]
        if ($pkg.envs) {
            foreach ($envName in $pkg.envs.Keys) {
                $envValue = $pkg.envs[$envName]
                $lines += "$envName=$envValue"
            }
        }
    }

    # Custom envs from config (Envs section)
    if ($Config.Envs -and $Config.Envs.Count -gt 0) {
        $lines += ""
        $lines += "# Custom Variables"
        foreach ($key in $Config.Envs.Keys) {
            $value = $Config.Envs[$key]
            $lines += "$key=$value"
        }
    }

    $lines -join "`n" | Out-File $envPath -Encoding UTF8 -NoNewline
    Write-Success "Generated .env"
}

function Generate-AllEnvFiles {
    Generate-DotEnvFile
}

# ============================================================================
# Env Commands
# ============================================================================

function Show-EnvList {
    Write-Host ""
    Write-Host "Environment Variables:" -ForegroundColor Cyan
    Write-Host ""

    $state = Load-State

    # Project settings
    Write-Host "  [Project Settings]" -ForegroundColor Yellow
    if ($Config.Project) {
        if ($Config.Project.Name) {
            Write-Host "    PROGRAM_NAME = $($Config.Project.Name)" -ForegroundColor White
        }
        if ($Config.Project.DefaultCPU) {
            Write-Host "    DEFAULT_CPU = $($Config.Project.DefaultCPU)" -ForegroundColor White
        }
        if ($Config.Project.DefaultFPU) {
            Write-Host "    DEFAULT_FPU = $($Config.Project.DefaultFPU)" -ForegroundColor White
        }
        if ($Config.Project.Version) {
            Write-Host "    VERSION = $($Config.Project.Version)" -ForegroundColor White
        }
    }

    # Paths
    Write-Host ""
    Write-Host "  [Project Paths]" -ForegroundColor Yellow
    if ($Config.Paths) {
        foreach ($key in $Config.Paths.Keys) {
            $value = $Config.Paths[$key]
            $envKey = ($key -creplace '([A-Z])', '_$1').ToUpper().TrimStart('_')
            Write-Host "    $envKey = $value" -ForegroundColor White
        }
    }

    # Package envs
    Write-Host ""
    Write-Host "  [Package Paths]" -ForegroundColor Yellow
    foreach ($pkgName in $state.packages.Keys) {
        $pkg = $state.packages[$pkgName]
        if ($pkg.envs -and $pkg.envs.Count -gt 0) {
            foreach ($envName in $pkg.envs.Keys) {
                $envValue = $pkg.envs[$envName]
                Write-Host "    $envName = $envValue" -ForegroundColor White -NoNewline
                Write-Host " ($pkgName)" -ForegroundColor DarkGray
            }
        }
    }

    # Custom envs from config
    if ($Config.Envs -and $Config.Envs.Count -gt 0) {
        Write-Host ""
        Write-Host "  [Custom Variables]" -ForegroundColor Yellow
        foreach ($key in $Config.Envs.Keys) {
            $value = $Config.Envs[$key]
            Write-Host "    $key = $value" -ForegroundColor White
        }
    }

    Write-Host ""
}
